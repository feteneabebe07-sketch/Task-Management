{% extends 'admins/base.html' %}
{% load static %}

{% block title %}Employees Management{% endblock %}

{% block header_title %}Employees Management{% endblock %}

{% block page_title %}Employee Management{% endblock %}
{% block page_subtitle %}Manage and organize company employees efficiently{% endblock %}

{% block header_actions %}
<button onclick="openCreateEmployeeModal()" class="btn-primary text-white px-5 py-2.5 rounded-xl font-medium shadow-lg hover:shadow-xl transition-all">
    <i class="fas fa-user-plus mr-2"></i>
    Register Employee
</button>

{% endblock %}

{% block content %}
<div class="space-y-6 md:space-y-8">
  
    
    <!-- Main Content Area -->
    <div class="stat-card p-6">
        <!-- Table Header -->
        <div class="flex flex-col md:flex-row md:items-center justify-between mb-6">
            <div>
                <h3 class="text-lg md:text-xl font-bold text-ink-black mb-1">All Employees</h3>
                <p class="text-dark-cyan/70 text-sm">Manage your workforce efficiently</p>
            </div>
            <div class="flex items-center space-x-3 mt-4 md:mt-0">
                <div class="relative">
                    <input type="text" id="employeeSearch" 
                           placeholder="Search employees..." 
                           class="pl-10 pr-4 py-2.5 form-input rounded-xl focus:outline-none focus:w-64 transition-all duration-300 w-full md:w-56">
                    <i class="fas fa-search absolute left-3 top-3 text-dark-cyan"></i>
                </div>
                <button class="px-4 py-2.5 border border-vanilla-custard/30 rounded-xl hover:border-dark-teal/50 hover:bg-dark-teal/5 transition-all text-dark-teal font-medium">
                    <i class="fas fa-filter mr-2"></i>
                    Filter
                </button>
            </div>
        </div>
        
        <!-- Employees Table -->
        <div class="overflow-x-auto rounded-xl border border-vanilla-custard/30">
            <table class="w-full">
                <thead>
                    <tr class="bg-gradient-to-r from-dark-teal/5 to-dark-cyan/5">
                        <th class="text-left py-4 px-6 text-sm font-medium text-dark-teal">Employee</th>
                        <th class="text-left py-4 px-6 text-sm font-medium text-dark-teal">Department</th>
                        <th class="text-left py-4 px-6 text-sm font-medium text-dark-teal">Role</th>
                        <th class="text-left py-4 px-6 text-sm font-medium text-dark-teal">Join Date</th>
                        <th class="text-left py-4 px-6 text-sm font-medium text-dark-teal">Status</th>
                        <th class="text-left py-4 px-6 text-sm font-medium text-dark-teal">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100" id="employeesTableBody">
                    {% for employee in employees %}
                    <tr class="table-row-hover group" data-employee-id="{{ employee.id }}">
                        <td class="py-4 px-6">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-dark-teal to-dark-cyan flex items-center justify-center text-white font-bold text-sm mr-3 shadow-md">
                                    {{ employee.user.first_name|first|upper }}{{ employee.user.last_name|first|upper }}
                                </div>
                                <div>
                                    <h4 class="font-medium text-ink-black text-sm group-hover:text-dark-teal">{{ employee.user.get_full_name|default:employee.user.username }}</h4>
                                    <p class="text-xs text-dark-cyan/70 mt-1 truncate max-w-[150px]">{{ employee.user.email|default:"No email" }}</p>
                                </div>
                            </div>
                        </td>
                        <td class="py-4 px-6">
                            {% if employee.department %}
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-dark-teal/10 text-dark-teal">
                                <i class="fas fa-building mr-1.5 text-xs"></i>
                                {{ employee.department.name|truncatechars:20 }}
                            </span>
                            {% else %}
                            <span class="text-sm text-dark-cyan/70 italic">Not assigned</span>
                            {% endif %}
                        </td>
                        <td class="py-4 px-6">
                            <div class="flex items-center">
                                <div class="w-2 h-2 rounded-full mr-2
                                    {% if employee.user.role == 'admin' %}bg-dark-teal
                                    {% elif employee.user.role == 'pm' %}bg-dark-cyan
                                    {% elif employee.user.role == 'developer' %}bg-golden-orange
                                    {% elif employee.user.role == 'designer' %}bg-pearl-aqua
                                    {% elif employee.user.role == 'qa' %}bg-rusty-spice
                                    {% else %}bg-dark-cyan{% endif %}"></div>
                                <span class="text-sm text-ink-black font-medium">
                                    {% if employee.job_position %}
                                        {{ employee.job_position }}
                                    {% else %}
                                        {{ employee.user.get_role_display|default:"Employee" }}
                                    {% endif %}
                                </span>
                            </div>
                        </td>
                        <td class="py-4 px-6">
                            <div class="flex items-center text-sm text-dark-cyan">
                                <i class="far fa-calendar-alt mr-2 text-xs"></i>
                                {% if employee.hire_date %}
                                    {{ employee.hire_date|date:"d M Y" }}
                                {% else %}
                                    <span class="text-dark-cyan/70 italic">Not set</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="py-4 px-6">
                            {% if employee.status == 'active' %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gradient-to-r from-dark-cyan/10 to-pearl-aqua/10 text-dark-cyan border border-dark-cyan/20">
                                    <span class="w-1.5 h-1.5 rounded-full bg-dark-cyan mr-1.5"></span>
                                    Active
                                </span>
                            {% elif employee.status == 'on_leave' %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gradient-to-r from-golden-orange/10 to-burnt-caramel/10 text-golden-orange border border-golden-orange/20">
                                    <span class="w-1.5 h-1.5 rounded-full bg-golden-orange mr-1.5"></span>
                                    On Leave
                                </span>
                            {% elif employee.status == 'inactive' %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gradient-to-r from-rusty-spice/10 to-oxidized-iron/10 text-rusty-spice border border-rusty-spice/20">
                                    <span class="w-1.5 h-1.5 rounded-full bg-rusty-spice mr-1.5"></span>
                                    Inactive
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gradient-to-r from-vanilla-custard/10 to-dark-cyan/10 text-dark-cyan border border-vanilla-custard/20">
                                    <span class="w-1.5 h-1.5 rounded-full bg-dark-cyan mr-1.5"></span>
                                    {{ employee.status|title }}
                                </span>
                            {% endif %}
                        </td>
                        <td class="py-4 px-6">
                            <div class="flex items-center space-x-2">
                                <button onclick="viewEmployee({{ employee.id }})" 
                                        class="w-8 h-8 flex items-center justify-center rounded-lg bg-dark-teal/10 text-dark-teal hover:bg-dark-teal hover:text-white transition-all duration-300 group"
                                        data-tooltip="View Details">
                                    <i class="fas fa-eye text-sm group-hover:scale-110"></i>
                                </button>
                                <button onclick="editEmployee({{ employee.id }})" 
                                        class="w-8 h-8 flex items-center justify-center rounded-lg bg-golden-orange/10 text-golden-orange hover:bg-golden-orange hover:text-white transition-all duration-300 group"
                                        data-tooltip="Edit Employee">
                                    <i class="fas fa-edit text-sm group-hover:scale-110"></i>
                                </button>
                                
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="py-12 text-center">
                            <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-vanilla-custard/20 to-dark-cyan/20 flex items-center justify-center">
                                <i class="fas fa-users text-dark-cyan text-2xl"></i>
                            </div>
                            <h4 class="text-lg font-medium text-ink-black mb-2">No Employees Found</h4>
                            <p class="text-dark-cyan/70 mb-6">Get started by registering your first employee</p>
                            <button onclick="openCreateEmployeeModal()" class="btn-primary text-white px-5 py-2.5 rounded-xl font-medium">
                                <i class="fas fa-user-plus mr-2"></i>
                                Register Employee
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="flex flex-col sm:flex-row justify-between items-center mt-6 pt-6 border-t border-vanilla-custard/30">
            <p class="text-sm text-dark-cyan/70 mb-4 sm:mb-0">
                Showing <span class="font-medium text-ink-black">{{ employees|length }}</span> employees
            </p>
            <div class="flex items-center space-x-2">
                <button class="w-10 h-10 flex items-center justify-center rounded-lg border border-vanilla-custard/30 hover:border-dark-teal/50 hover:bg-dark-teal/5 transition-all">
                    <i class="fas fa-chevron-left text-dark-cyan"></i>
                </button>
                <span class="text-sm font-medium text-ink-black">Page 1 of 1</span>
                <button class="w-10 h-10 flex items-center justify-center rounded-lg border border-vanilla-custard/30 hover:border-dark-teal/50 hover:bg-dark-teal/5 transition-all">
                    <i class="fas fa-chevron-right text-dark-cyan"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_modals %}
<!-- Enhanced Create Employee Modal -->
<div id="createEmployeeModal" class="fixed inset-0 bg-ink-black/70 overflow-y-auto h-full w-full hidden modal z-50 modal-overlay">
    <div class="relative top-4 md:top-20 mx-auto p-4 md:p-5 border w-11/12 md:w-full max-w-3xl shadow-2xl rounded-xl bg-white">
        <div class="relative">
            <!-- Modal Header -->
            <div class="flex items-center justify-between pb-4 mb-4 border-b border-vanilla-custard/30">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-golden-orange/10 to-burnt-caramel/10 flex items-center justify-center mr-3">
                        <i class="fas fa-user-plus text-golden-orange text-lg"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-ink-black">Register Employee</h3>
                        <p class="text-sm text-dark-cyan/70">Add new team member to the system</p>
                    </div>
                </div>
                <button onclick="closeModal('createEmployeeModal')" 
                        class="text-dark-cyan/70 hover:text-oxidized-iron transition-colors p-2 rounded-full hover:bg-gray-100">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            
            <!-- Form -->
            <form id="createEmployeeForm" class="space-y-6">
                {% csrf_token %}
                
                <!-- Personal Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-sm font-medium text-dark-teal mb-2 flex items-center">
                            <i class="fas fa-user mr-2 text-dark-cyan"></i>
                            Full Name *
                        </label>
                        <input type="text" name="full_name" 
                               class="w-full px-4 py-3 form-input rounded-xl focus:outline-none focus:ring-2 focus:ring-dark-teal focus:border-transparent"
                               placeholder="Enter full name" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-dark-teal mb-2 flex items-center">
                            <i class="fas fa-envelope mr-2 text-dark-cyan"></i>
                            Email Address *
                        </label>
                        <input type="email" name="email" 
                               class="w-full px-4 py-3 form-input rounded-xl focus:outline-none focus:ring-2 focus:ring-dark-teal focus:border-transparent"
                               placeholder="Enter email address" required>
                    </div>
                </div>
                
                <!-- Contact & Department -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-sm font-medium text-dark-teal mb-2 flex items-center">
                            <i class="fas fa-phone mr-2 text-dark-cyan"></i>
                            Phone Number
                        </label>
                        <input type="tel" name="phone" 
                               class="w-full px-4 py-3 form-input rounded-xl focus:outline-none focus:ring-2 focus:ring-dark-teal focus:border-transparent"
                               placeholder="Enter phone number">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-dark-teal mb-2 flex items-center">
                            <i class="fas fa-building mr-2 text-dark-cyan"></i>
                            Department *
                        </label>
                        <select name="department" 
                                class="w-full px-4 py-3 form-select rounded-xl focus:outline-none focus:ring-2 focus:ring-dark-teal focus:border-transparent" required>
                            <option value="">Select department</option>
                            {% for department in departments %}
                            <option value="{{ department.id }}">{{ department.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <!-- Role & Position -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-sm font-medium text-dark-teal mb-2 flex items-center">
                            <i class="fas fa-id-badge mr-2 text-dark-cyan"></i>
                            Role *
                        </label>
                        <select name="role" 
                                class="w-full px-4 py-3 form-select rounded-xl focus:outline-none focus:ring-2 focus:ring-dark-teal focus:border-transparent" required>
                            <option value="">Select role</option>
                            <option value="admin" class="text-dark-teal">Administrator</option>
                            <option value="pm" class="text-golden-orange">Project Manager</option>
                            <option value="developer" class="text-dark-cyan">Developer</option>
                            <option value="designer" class="text-pearl-aqua">Designer</option>
                            <option value="qa" class="text-rusty-spice">QA Tester</option>
                            <option value="sales" class="text-burnt-caramel">Sales Executive</option>
                            <option value="hr" class="text-oxidized-iron">HR Manager</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-dark-teal mb-2 flex items-center">
                            <i class="fas fa-briefcase mr-2 text-dark-cyan"></i>
                            Job Position *
                        </label>
                        <input type="text" name="position" 
                               class="w-full px-4 py-3 form-input rounded-xl focus:outline-none focus:ring-2 focus:ring-dark-teal focus:border-transparent"
                               placeholder="Enter job position" required>
                    </div>
                </div>
                
                <!-- Salary & Join Date -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-sm font-medium text-dark-teal mb-2 flex items-center">
                            <i class="fas fa-dollar-sign mr-2 text-dark-cyan"></i>
                            Salary
                        </label>
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-dark-cyan font-medium">$</span>
                            <input type="number" name="salary" 
                                   class="w-full pl-8 px-4 py-3 form-input rounded-xl focus:outline-none focus:ring-2 focus:ring-dark-teal focus:border-transparent"
                                   placeholder="0.00" step="0.01">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-dark-teal mb-2 flex items-center">
                            <i class="fas fa-calendar-alt mr-2 text-dark-cyan"></i>
                            Join Date *
                        </label>
                        <input type="date" name="join_date" 
                               class="w-full px-4 py-3 form-input rounded-xl focus:outline-none focus:ring-2 focus:ring-dark-teal focus:border-transparent" required>
                    </div>
                </div>
                
                <!-- Skills & Status -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div>
                        <label class="block text-sm font-medium text-dark-teal mb-2 flex items-center">
                            <i class="fas fa-tools mr-2 text-dark-cyan"></i>
                            Skills
                        </label>
                        <input type="text" name="skills" 
                               class="w-full px-4 py-3 form-input rounded-xl focus:outline-none focus:ring-2 focus:ring-dark-teal focus:border-transparent"
                               placeholder="Enter skills (comma separated)">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-dark-teal mb-2 flex items-center">
                            <i class="fas fa-power-off mr-2 text-dark-cyan"></i>
                            Status
                        </label>
                        <select name="status" 
                                class="w-full px-4 py-3 form-select rounded-xl focus:outline-none focus:ring-2 focus:ring-dark-teal focus:border-transparent">
                            <option value="active" class="text-dark-cyan">Active</option>
                            <option value="inactive" class="text-rusty-spice">Inactive</option>
                            <option value="on_leave" class="text-golden-orange">On Leave</option>
                        </select>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex justify-end space-x-3 pt-6 border-t border-vanilla-custard/30">
                    <button type="button" onclick="closeModal('createEmployeeModal')" 
                            class="px-5 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-all font-medium">
                        Cancel
                    </button>
                    <button type="button" onclick="registerEmployee()" 
                            class="px-5 py-3 btn-primary text-white rounded-xl font-medium shadow-lg hover:shadow-xl transition-all">
                        <i class="fas fa-user-plus mr-2"></i>
                        Register Employee
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Enhanced View Employee Modal -->
<div id="viewEmployeeModal" class="fixed inset-0 bg-ink-black/70 overflow-y-auto h-full w-full hidden modal z-50 modal-overlay">
    <div class="relative top-4 md:top-20 mx-auto p-4 md:p-5 border w-11/12 md:w-full max-w-3xl shadow-2xl rounded-xl bg-white">
        <div class="relative">
            <!-- Modal Header -->
            <div class="flex items-center justify-between pb-4 mb-4 border-b border-vanilla-custard/30">
                <div class="flex items-center">
                    <div id="viewEmpAvatar" class="w-12 h-12 rounded-lg bg-gradient-to-br from-dark-teal to-dark-cyan flex items-center justify-center text-white font-bold text-lg mr-3">
                        <!-- Avatar will be set by JS -->
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-ink-black" id="viewEmpName">Employee Details</h3>
                        <p class="text-sm text-dark-cyan/70" id="viewEmpEmail">Loading...</p>
                    </div>
                </div>
                <button onclick="closeModal('viewEmployeeModal')" 
                        class="text-dark-cyan/70 hover:text-oxidized-iron transition-colors p-2 rounded-full hover:bg-gray-100">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            
            <!-- Content -->
            <div class="space-y-6">
                <!-- Employee Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div class="bg-gradient-to-br from-dark-teal/5 to-dark-cyan/5 p-5 rounded-xl">
                        <h4 class="font-medium text-ink-black mb-4 flex items-center">
                            <i class="fas fa-user-circle mr-2 text-dark-teal"></i>
                            Personal Information
                        </h4>
                        <div class="space-y-3">
                            <div>
                                <p class="text-xs text-dark-cyan/70">Full Name</p>
                                <p class="font-medium text-ink-black mt-1" id="viewEmpFullName"></p>
                            </div>
                            <div>
                                <p class="text-xs text-dark-cyan/70">Email</p>
                                <p class="font-medium text-ink-black mt-1" id="viewEmpEmailDetail"></p>
                            </div>
                            <div>
                                <p class="text-xs text-dark-cyan/70">Phone</p>
                                <p class="font-medium text-ink-black mt-1" id="viewEmpPhone"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-golden-orange/5 to-burnt-caramel/5 p-5 rounded-xl">
                        <h4 class="font-medium text-ink-black mb-4 flex items-center">
                            <i class="fas fa-briefcase mr-2 text-golden-orange"></i>
                            Work Information
                        </h4>
                        <div class="space-y-3">
                            <div>
                                <p class="text-xs text-dark-cyan/70">Department</p>
                                <p class="font-medium text-ink-black mt-1" id="viewEmpDept"></p>
                            </div>
                            <div>
                                <p class="text-xs text-dark-cyan/70">Position</p>
                                <p class="font-medium text-ink-black mt-1" id="viewEmpPosition"></p>
                            </div>
                            <div>
                                <p class="text-xs text-dark-cyan/70">Employee ID</p>
                                <p class="font-medium text-ink-black mt-1" id="viewEmpId"></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Status & Join Date -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div class="bg-gradient-to-br from-dark-cyan/5 to-pearl-aqua/5 p-5 rounded-xl">
                        <h4 class="font-medium text-ink-black mb-4 flex items-center">
                            <i class="fas fa-chart-line mr-2 text-dark-cyan"></i>
                            Status & Timeline
                        </h4>
                        <div class="space-y-3">
                            <div>
                                <p class="text-xs text-dark-cyan/70">Status</p>
                                <p class="mt-1" id="viewEmpStatus"></p>
                            </div>
                            <div>
                                <p class="text-xs text-dark-cyan/70">Join Date</p>
                                <p class="font-medium text-ink-black mt-1" id="viewEmpJoinDate"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gradient-to-br from-pearl-aqua/5 to-dark-cyan/5 p-5 rounded-xl">
                        <h4 class="font-medium text-ink-black mb-4 flex items-center">
                            <i class="fas fa-dollar-sign mr-2 text-pearl-aqua"></i>
                            Compensation
                        </h4>
                        <div class="space-y-3">
                            <div>
                                <p class="text-xs text-dark-cyan/70">Salary</p>
                                <p class="font-medium text-ink-black mt-1" id="viewEmpSalary"></p>
                            </div>
                            <div>
                                <p class="text-xs text-dark-cyan/70">Role</p>
                                <p class="font-medium text-ink-black mt-1" id="viewEmpRole"></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Skills -->
                <div class="bg-gradient-to-br from-vanilla-custard/5 to-dark-cyan/5 p-5 rounded-xl">
                    <h4 class="font-medium text-ink-black mb-4 flex items-center">
                        <i class="fas fa-tools mr-2 text-dark-cyan"></i>
                        Skills & Expertise
                    </h4>
                    <div class="flex flex-wrap gap-2" id="viewEmpSkills">
                        <!-- Skills will be populated by JS -->
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex justify-end space-x-3 pt-6 border-t border-vanilla-custard/30">
                    <button type="button" onclick="closeModal('viewEmployeeModal')" 
                            class="px-5 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-all font-medium">
                        Close
                    </button>
                    <button type="button" onclick="editCurrentEmployee()" 
                            class="px-5 py-3 btn-secondary text-white rounded-xl font-medium">
                        <i class="fas fa-edit mr-2"></i>
                        Edit Employee
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Employee-specific constants
    const ADMIN_API_CREATE_EMPLOYEE = "{% url 'admins:api_create_employee' %}";
    const ADMIN_API_GET_EMPLOYEE = "{% url 'admins:api_get_employee' 0 %}";
    const ADMIN_API_UPDATE_EMPLOYEE = "{% url 'admins:api_update_employee' 0 %}";

    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Set today as default for join date in create form
        const today = new Date().toISOString().split('T')[0];
        const joinDateInput = document.querySelector('#createEmployeeForm input[name="join_date"]');
        if (joinDateInput) {
            joinDateInput.value = today;
        }
        
        // Initialize search functionality
        const searchInput = document.getElementById('employeeSearch');
        if (searchInput) {
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('#employeesTableBody tr');
                
                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }
        
        // Add hover effects to table rows
        const tableRows = document.querySelectorAll('#employeesTableBody tr');
        tableRows.forEach(row => {
            row.addEventListener('mouseenter', function() {
                this.classList.add('bg-gradient-to-r', 'from-vanilla-custard/10', 'to-dark-teal/5');
            });
            
            row.addEventListener('mouseleave', function() {
                this.classList.remove('bg-gradient-to-r', 'from-vanilla-custard/10', 'to-dark-teal/5');
            });
        });
    });
    
    // Modal functions
    function openCreateEmployeeModal() {
        document.getElementById('createEmployeeModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }
    
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }
    }
    
    // Register employee function
    async function registerEmployee() {
        const form = document.getElementById('createEmployeeForm');
        if (!form) return;
        
        // Validate form
        let isValid = true;
        form.querySelectorAll('[required]').forEach(field => {
            if (!field.value.trim()) {
                field.classList.add('border-red-300', 'ring-2', 'ring-red-200');
                isValid = false;
            } else {
                field.classList.remove('border-red-300', 'ring-2', 'ring-red-200');
            }
        });
        
        if (!isValid) {
            showToast('Validation Error', 'Please fill all required fields', 'error');
            return;
        }
        
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        try {
            showToast('Processing', 'Registering employee...', 'info');
            
            const response = await fetch(ADMIN_API_CREATE_EMPLOYEE, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast('Success', 'Employee registered successfully!', 'success');
                closeModal('createEmployeeModal');
                form.reset();
                
                // Reload after 1.5 seconds
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('Error', result.error || 'Failed to register employee', 'error');
            }
        } catch (error) {
            console.error('Error registering employee:', error);
            showToast('Error', 'Network error occurred', 'error');
        }
    }
    
    // View employee details
    async function viewEmployee(employeeId) {
        try {
            const response = await fetch(ADMIN_API_GET_EMPLOYEE.replace('0', employeeId));
            if (!response.ok) throw new Error('Failed to fetch employee details');
            
            const employee = await response.json();
            
            // Populate modal with employee data
            const fullName = employee.full_name || employee.user?.get_full_name || 'N/A';
            const firstName = fullName.split(' ')[0] || 'E';
            const lastName = fullName.split(' ')[1] || 'M';
            const initials = (firstName[0] + lastName[0]).toUpperCase();
            
            // Set header info
            document.getElementById('viewEmpName').textContent = fullName;
            document.getElementById('viewEmpEmail').textContent = employee.email || employee.user?.email || 'No email';
            document.getElementById('viewEmpAvatar').textContent = initials;
            
            // Set personal info
            document.getElementById('viewEmpFullName').textContent = fullName;
            document.getElementById('viewEmpEmailDetail').textContent = employee.email || employee.user?.email || 'No email';
            document.getElementById('viewEmpPhone').textContent = employee.phone || 'Not provided';
            
            // Set work info
            document.getElementById('viewEmpDept').textContent = employee.department_name || 'Not assigned';
            document.getElementById('viewEmpPosition').textContent = employee.job_position || employee.role || 'N/A';
            document.getElementById('viewEmpId').textContent = employee.employee_id || employee.id || 'N/A';
            
            // Set status & join date
            document.getElementById('viewEmpJoinDate').textContent = employee.hire_date || 'Not set';
            document.getElementById('viewEmpSalary').textContent = employee.salary ? '$' + parseFloat(employee.salary).toLocaleString('en-US', {minimumFractionDigits: 2}) : 'Not specified';
            document.getElementById('viewEmpRole').textContent = employee.role ? employee.role.charAt(0).toUpperCase() + employee.role.slice(1) : 'N/A';
            
            // Set status badge
            const statusElement = document.getElementById('viewEmpStatus');
            let statusClass = 'inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ';
            let statusText = employee.status ? employee.status.charAt(0).toUpperCase() + employee.status.slice(1) : 'Unknown';
            
            if (employee.status === 'active') {
                statusClass += 'bg-gradient-to-r from-dark-cyan/10 to-pearl-aqua/10 text-dark-cyan border border-dark-cyan/20';
            } else if (employee.status === 'on_leave') {
                statusClass += 'bg-gradient-to-r from-golden-orange/10 to-burnt-caramel/10 text-golden-orange border border-golden-orange/20';
            } else if (employee.status === 'inactive') {
                statusClass += 'bg-gradient-to-r from-rusty-spice/10 to-oxidized-iron/10 text-rusty-spice border border-rusty-spice/20';
            } else {
                statusClass += 'bg-gradient-to-r from-vanilla-custard/10 to-dark-cyan/10 text-dark-cyan border border-vanilla-custard/20';
            }
            
            statusElement.innerHTML = `
                <span class="${statusClass}">
                    <span class="w-1.5 h-1.5 rounded-full mr-1.5 ${employee.status === 'active' ? 'bg-dark-cyan' : employee.status === 'on_leave' ? 'bg-golden-orange' : employee.status === 'inactive' ? 'bg-rusty-spice' : 'bg-dark-cyan'}"></span>
                    ${statusText}
                </span>
            `;
            
            // Set skills
            const skillsContainer = document.getElementById('viewEmpSkills');
            skillsContainer.innerHTML = '';
            if (employee.skills) {
                const skills = employee.skills.split(',').map(skill => skill.trim()).filter(skill => skill);
                if (skills.length > 0) {
                    skills.forEach(skill => {
                        const skillEl = document.createElement('span');
                        skillEl.className = 'px-3 py-1.5 bg-gradient-to-r from-dark-teal/10 to-dark-cyan/10 text-dark-teal text-xs rounded-full font-medium border border-dark-teal/20';
                        skillEl.textContent = skill;
                        skillsContainer.appendChild(skillEl);
                    });
                } else {
                    skillsContainer.innerHTML = '<p class="text-sm text-dark-cyan/70 italic">No skills listed</p>';
                }
            } else {
                skillsContainer.innerHTML = '<p class="text-sm text-dark-cyan/70 italic">No skills listed</p>';
            }
            
            // Store current employee ID for edit function
            document.getElementById('viewEmployeeModal').dataset.employeeId = employeeId;
            
            openModal('viewEmployeeModal');
        } catch (error) {
            console.error('Error loading employee details:', error);
            showToast('Error', 'Failed to load employee details', 'error');
        }
    }
    
    function editCurrentEmployee() {
        const employeeId = document.getElementById('viewEmployeeModal').dataset.employeeId;
        if (employeeId) {
            editEmployee(employeeId);
        }
    }
    
    // Edit employee function
    async function editEmployee(employeeId) {
        try {
            const response = await fetch(ADMIN_API_GET_EMPLOYEE.replace('0', employeeId));
            if (!response.ok) throw new Error('Failed to fetch employee details');
            
            const employee = await response.json();
            
            // Fill the create employee form with existing data
            const form = document.getElementById('createEmployeeForm');
            if (form) {
                form.querySelector('input[name="full_name"]').value = employee.full_name || employee.user?.get_full_name || '';
                form.querySelector('input[name="email"]').value = employee.email || employee.user?.email || '';
                form.querySelector('input[name="phone"]').value = employee.phone || '';
                form.querySelector('select[name="department"]').value = employee.department_id || '';
                form.querySelector('select[name="role"]').value = employee.role || '';
                form.querySelector('input[name="position"]').value = employee.job_position || '';
                form.querySelector('input[name="salary"]').value = employee.salary || '';
                form.querySelector('input[name="join_date"]').value = employee.hire_date || '';
                form.querySelector('input[name="skills"]').value = employee.skills || '';
                form.querySelector('select[name="status"]').value = employee.status || 'active';
                
                // Change modal title
                const modalTitle = form.closest('.modal').querySelector('h3');
                if (modalTitle) modalTitle.textContent = 'Edit Employee';
                
                // Change submit button text
                const submitBtn = form.querySelector('button[type="button"]:last-child');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Update Employee';
                    submitBtn.onclick = function() { updateEmployee(employeeId); };
                }
                
                closeModal('viewEmployeeModal');
                openCreateEmployeeModal();
            }
        } catch (error) {
            console.error('Error loading employee for edit:', error);
            showToast('Error', 'Failed to load employee details', 'error');
        }
    }
    
    // Update employee function
    async function updateEmployee(employeeId) {
        const form = document.getElementById('createEmployeeForm');
        if (!form) return;
        
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        
        try {
            showToast('Processing', 'Updating employee...', 'info');
            
            const response = await fetch(ADMIN_API_UPDATE_EMPLOYEE.replace('0', employeeId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showToast('Success', 'Employee updated successfully!', 'success');
                closeModal('createEmployeeModal');
                
                // Reset form and button
                form.reset();
                const submitBtn = form.querySelector('button[type="button"]:last-child');
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-user-plus mr-2"></i>Register Employee';
                    submitBtn.onclick = function() { registerEmployee(); };
                }
                
                // Reload after 1.5 seconds
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('Error', result.error || 'Failed to update employee', 'error');
            }
        } catch (error) {
            console.error('Error updating employee:', error);
            showToast('Error', 'Network error occurred', 'error');
        }
    }

    
    // Load stats details (placeholder function)
    async function loadStatsDetails(type) {
        showToast('Statistics', `Loading detailed statistics for ${type.replace('_', ' ')}...`, 'info');
        // In a real implementation, this would fetch and display detailed stats
    }
    
    // Helper function to open modal
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
    }
</script>
{% endblock %}